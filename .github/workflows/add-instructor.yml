on:
  issues:
    types: [opened]
permissions:
  contents: write

jobs:
  pr:
    runs-on: ubuntu-latest
    steps:
      - name: Validate issue title
        run: |
          TITLE="${{ github.event.issue.title }}"
          if ! echo "$TITLE" | grep -Eq '^(Add|Update) Instructor Abbreviation:'; then
            echo "::error::Issue title must start with \"Add Instructor Abbreviation:\" or \"Update Instructor Abbreviation:\""
            exit 1
          fi

      - name: Generate GitHub App Token
        uses: tibdex/github-app-token@v2
        id: generate-token
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          token: ${{ steps.generate-token.outputs.token }}

      - name: Setup Pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          node-version: 22.14.0

      - name: Install dependencies
        run: pnpm install

      - name: Update
        run: npx tsx scripts/update_instructor.ts
        env:
          BODY: '${{ github.event.issue.body }}'

      - name: Format
        run: npx prettier --write src/db/data.ts

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.generate-token.outputs.token }}
          commit-message: 'Add or Update Instructor Abbreviation from issue #${{ github.event.issue.number }}'
          committer: Jarn-Nai[bot] <1505243+Jarn-Nai[bot]@users.noreply.github.com>
          title: 'Automated ${{ github.event.issue.title }}'
          body: |
            This PR was automatically generated in response to issue #${{ github.event.issue.number }}.

            **Summary of changes:**
            - ${{
                github.event.issue.title
              }}

            Please review the changes to `src/db/data.ts` and ensure the instructor abbreviation information is correct.
          branch: instructor-abbreviation/${{ github.event.issue.number }}
          delete-branch: true
          add-paths: |
            src/db/data.ts
          labels: |
            üßë‚Äçüè´ instructor
          reviewers: |
            yokeTH
            Thiraput01
