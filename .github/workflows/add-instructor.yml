on:
  issues:
    types: [opened]
  pull_request:
    types: [closed]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  pr:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'pull_request' && startsWith(github.event.pull_request.head.ref, 'instructor-abbreviation/')) ||
      github.event_name == 'workflow_dispatch'
    steps:
      - name: Validate issue title
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Skipping issue title validation for workflow_dispatch."
            exit 0
          fi

          TITLE="${{ github.event.issue.title }}"
          if ! echo "$TITLE" | grep -q 'Instructor Abbreviation:'; then
            echo "::error::Issue title must start with \"Add Instructor Abbreviation:\" or \"Update Instructor Abbreviation:\""
            exit 1
          fi

      - name: Generate GitHub App Token
        uses: tibdex/github-app-token@v2
        id: generate-token
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          lfs: true
          token: ${{ steps.generate-token.outputs.token }}

      - name: Check for any open instructor-abbreviation PRs
        run: |
          echo "Checking for open PRs with branch name starting with instructor-abbreviation/"

          OPEN_PR=$(gh pr list --state open --json number,headRefName,title \
            --jq '.[] | select(.headRefName | startswith("instructor-abbreviation/"))')

          if [ -n "$OPEN_PR" ]; then
            echo "$OPEN_PR" | jq -c '.'
            echo "::error::Another instructor-abbreviation PR is still open. Please wait until it is merged or closed."
            exit 0
          fi

          echo "No conflicting open PRs found. Proceeding..."
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}

      - name: Setup Pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22

      - name: Set git to use HTTPS instead of SSH for github.com
        run: git config --global url."https://github.com/".insteadOf "git@github.com:"

      - name: Install dependencies
        run: pnpm install

      - name: Get Issue Body for Workflow Dispatch
        if: ${{ github.event_name == 'workflow_dispatch' }}
        id: pick-issue
        run: |
          echo "Getting issue body for workflow_dispatch..."
          ISSUE_JSON=$(gh issue list --state open --json number,title,body \
            --jq '.[] | select(.title | test("^(Add/Update|Add|Update) Instructor Abbreviation:"))')
          if [ -z "$ISSUE_JSON" ]; then
            echo "::error::No open issue found with title starting with \"Add Instructor Abbreviation:\" or \"Update Instructor Abbreviation:\""
            exit 1
          fi
          ISSUE_BODY=$(echo "$ISSUE_JSON" | jq -r '.body')
          ISSUE_NUMBER=$(echo "$ISSUE_JSON" | jq -r '.number')
          ISSUE_TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
          echo "BODY<<EOF" >> $GITHUB_ENV
          echo "$ISSUE_BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_ENV
          echo "ISSUE_TITLE=$ISSUE_TITLE" >> $GITHUB_ENV

        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}

      - name: Update
        run: npx tsx scripts/update_instructor.ts
        env:
          BODY: ${{ github.event_name == 'workflow_dispatch' && env.BODY || github.event.issue.body }}

      - name: Format
        run: npx prettier --write src/db/data.ts

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.generate-token.outputs.token }}
          commit-message: >-
            Add or Update Instructor Abbreviation from issue #${{ github.event_name == 'workflow_dispatch' && env.ISSUE_NUMBER || github.event.issue.number }}
          committer: Jarn-Nai[bot] <1505243+Jarn-Nai[bot]@users.noreply.github.com>
          title: >-
            Automated ${{ github.event_name == 'workflow_dispatch' && env.ISSUE_TITLE || github.event.issue.title }}
          body: |
            This PR was automatically generated in response to issue #${{ github.event_name == 'workflow_dispatch' && env.ISSUE_NUMBER || github.event.issue.number }}.

            **Summary of changes:**
            - ${{ github.event_name == 'workflow_dispatch' && env.ISSUE_TITLE || github.event.issue.title }}

            Please review the changes to `src/db/data.ts` and ensure the instructor abbreviation information is correct.
          branch: instructor-abbreviation/${{ github.event_name == 'workflow_dispatch' && env.ISSUE_NUMBER || github.event.issue.number }}
          delete-branch: true
          add-paths: |
            src/db/data.ts
          labels: |
            üßë‚Äçüè´ instructor
          reviewers: |
            yokeTH
            Thiraput01
