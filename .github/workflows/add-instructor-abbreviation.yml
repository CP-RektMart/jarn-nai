name: Add Instructor Abbreviation

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to process"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  add-instructor:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: Extract fields from issue and write JSON (if not exists)
        id: extract
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const fs = require("fs");
            const path = require("path");

            // Determine which issue to use (opened event vs manual dispatch)
            let issueNumber;
            if (context.eventName === "workflow_dispatch") {
              issueNumber = Number(context.payload.inputs.issue_number);
            } else {
              issueNumber = context.payload.issue.number;
            }

            // Get the issue (for workflow_dispatch we must fetch explicitly)
            let issue;
            if (context.eventName === "workflow_dispatch") {
              const { data } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
              });
              issue = data;
            } else {
              issue = context.payload.issue;
            }

            const body = issue.body || "";

            function extractField(label) {
              const regex = new RegExp(`### ${label}[\\r\\n]+([\\s\\S]*?)(?=\\n### |$)`);
              const match = body.match(regex);
              if (!match) return "";
              const value = match[1].trim();
              if (/^_No response_$/i.test(value)) return "";
              return value;
            }

            const abbreviation = extractField("Abbreviation");
            const fullName = extractField("Full Name");
            const faculty = extractField("Faculty");
            const department = extractField("Department");

            if (!abbreviation || !fullName || !faculty || !department) {
              core.setFailed("Missing one or more required fields (Abbreviation, Full Name, Faculty, Department).");
              return;
            }

            const dir = path.join(process.cwd(), "src", "db");
            if (!fs.existsSync(dir)) {
              fs.mkdirSync(dir, { recursive: true });
            }

            const filePath = path.join(dir, `${abbreviation}.json`);
            const exists = fs.existsSync(filePath);

            core.setOutput("abbreviation", abbreviation);
            core.setOutput("issue_number", issueNumber.toString());
            core.setOutput("json_exists", exists ? "true" : "false");

            if (exists) {
              core.info(`JSON already exists: ${filePath} ‚Äì will not overwrite.`);
              return; // do NOT write, do NOT fail, just skip
            }

            const data = {
              abbreviation,
              fullName,
              faculty,
              department,
            };

            fs.writeFileSync(filePath, JSON.stringify(data, null, 2) + "\n");
            core.info(`Wrote JSON to ${filePath}`);

      - name: Create Pull Request
        id: create_pr
        if: steps.extract.outputs.json_exists != 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: >
            Add instructor abbreviation
            ${{ steps.extract.outputs.abbreviation }} from
            #${{ steps.extract.outputs.issue_number }}
          title: >
            [Instructor] Add Instructor Abbreviation: ${{ steps.extract.outputs.abbreviation }}
          body: |
            This PR adds `src/db/${{ steps.extract.outputs.abbreviation }}.json`
            generated from issue #${{ steps.extract.outputs.issue_number }}.

            - Abbreviation: `${{ steps.extract.outputs.abbreviation }}`
            - Source issue: #${{ steps.extract.outputs.issue_number }}
          branch: >
            instructor/${{ steps.extract.outputs.abbreviation }}-${{ steps.extract.outputs.issue_number }}
          delete-branch: true
          add-paths: |
            src/db/${{ steps.extract.outputs.abbreviation }}.json
          labels: |
            üßë‚Äçüè´ instructor
          reviewers: |
            yokeTH

      - name: Comment when JSON already exists
        if: github.event_name == 'issues' && steps.extract.outputs.json_exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const abbreviation = "${{ steps.extract.outputs.abbreviation }}";
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `‚ö†Ô∏è Instructor abbreviation \`${abbreviation}\` already exists in \`src/db/${abbreviation}.json\`. No PR was created.`,
            });

      - name: Comment on issue with PR link
        if: github.event_name == 'issues' && steps.extract.outputs.json_exists != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const prNumber = "${{ steps.create_pr.outputs.pull-request-number }}";
            const prUrl = "${{ steps.create_pr.outputs.pull-request-url }}";
            const abbreviation = "${{ steps.extract.outputs.abbreviation }}";

            let body = `‚úÖ Generated \`src/db/${abbreviation}.json\` and opened a pull request.`;
            if (prNumber && prUrl) {
              body += `\n\nPR: #${prNumber} (${prUrl})`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body,
            });
